/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.benchmark.common.plan;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.util.Map;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;

class FeatureFlagCollectorTest {

	private static final String TEST_SYSTEM_PROPERTY = "rdf4j.query.plan.capture.test.property";

	@AfterEach
	void clearProperty() {
		System.clearProperty(TEST_SYSTEM_PROPERTY);
	}

	@Test
	void capturesSystemSupplierAndReflectionValues() {
		System.setProperty(TEST_SYSTEM_PROPERTY, "enabled");
		ProbeTarget target = new ProbeTarget();

		FeatureFlagCollector collector = new FeatureFlagCollector()
				.addSystemProperty("system.flag", TEST_SYSTEM_PROPERTY)
				.addValue("direct.flag", () -> target.directValue)
				.addReflectiveField("reflection.field", target, "hiddenFlag")
				.addReflectiveGetter("reflection.getter", target, "hiddenMode");

		Map<String, String> snapshot = collector.snapshot();
		assertEquals("enabled", snapshot.get("system.flag"));
		assertEquals("direct-on", snapshot.get("direct.flag"));
		assertEquals("true", snapshot.get("reflection.field"));
		assertEquals("fast-path", snapshot.get("reflection.getter"));
	}

	@Test
	void capturesProbeErrorsWithoutThrowing() {
		FeatureFlagCollector collector = new FeatureFlagCollector()
				.addReflectiveField("missing.field", new ProbeTarget(), "doesNotExist");

		Map<String, String> snapshot = collector.snapshot();
		assertTrue(snapshot.get("missing.field").startsWith(FeatureFlagCollector.ERROR_PREFIX),
				"Expected missing reflection field to be captured as an error marker");
	}

	private static final class ProbeTarget {
		private final boolean hiddenFlag = true;
		private final String directValue = "direct-on";

		@SuppressWarnings("unused")
		private String hiddenMode() {
			return "fast-path";
		}
	}
}
