/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.benchmark.plan;

import java.io.IOException;
import java.io.UncheckedIOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Comparator;
import java.util.stream.Stream;

import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator.Theme;
import org.eclipse.rdf4j.common.transaction.IsolationLevels;
import org.eclipse.rdf4j.repository.sail.SailRepository;
import org.eclipse.rdf4j.repository.sail.SailRepositoryConnection;
import org.eclipse.rdf4j.repository.util.RDFInserter;
import org.eclipse.rdf4j.sail.lmdb.LmdbStore;
import org.eclipse.rdf4j.sail.lmdb.config.LmdbStoreConfig;
import org.eclipse.rdf4j.sail.memory.MemoryStore;

final class QueryPlanSnapshotStoreSupport {

	private QueryPlanSnapshotStoreSupport() {
	}

	static void loadThemeData(SailRepository repository, Theme theme) throws IOException {
		try (SailRepositoryConnection connection = repository.getConnection()) {
			connection.begin(IsolationLevels.NONE);
			ThemeDataSetGenerator.generate(theme, new RDFInserter(connection));
			connection.commit();
		}
	}

	static StoreRuntime createStoreRuntime(QueryPlanSnapshotCliOptions options) throws IOException {
		if (options.store == QueryPlanSnapshotCliOptions.StoreType.MEMORY) {
			MemoryStore memoryStore = new MemoryStore();
			SailRepository repository = new SailRepository(memoryStore);
			return new StoreRuntime(repository, memoryStore, null, null, null, false);
		}

		Path dataDirectory = options.lmdbDataDirectory;
		boolean deleteDataDirectory = false;
		if (dataDirectory == null) {
			dataDirectory = Files.createTempDirectory("rdf4j-lmdb-plan-cli-");
			deleteDataDirectory = true;
		}
		LmdbStoreConfig config = new LmdbStoreConfig();
		LmdbStore lmdbStore = new LmdbStore(dataDirectory.toFile(), config);
		SailRepository repository = new SailRepository(lmdbStore);
		return new StoreRuntime(repository, null, lmdbStore, config, dataDirectory, deleteDataDirectory);
	}

	private static void deleteDirectory(Path directory) throws IOException {
		if (directory == null || !Files.exists(directory)) {
			return;
		}
		try (Stream<Path> walk = Files.walk(directory)) {
			walk.sorted(Comparator.reverseOrder())
					.forEach(path -> {
						try {
							Files.deleteIfExists(path);
						} catch (IOException e) {
							throw new UncheckedIOException(e);
						}
					});
		} catch (UncheckedIOException e) {
			throw e.getCause();
		}
	}

	static final class StoreRuntime implements AutoCloseable {
		final SailRepository repository;
		final MemoryStore memoryStore;
		final LmdbStore lmdbStore;
		final LmdbStoreConfig lmdbStoreConfig;
		private final Path dataDirectory;
		private final boolean deleteDataDirectory;

		private StoreRuntime(SailRepository repository, MemoryStore memoryStore, LmdbStore lmdbStore,
				LmdbStoreConfig lmdbStoreConfig, Path dataDirectory, boolean deleteDataDirectory) {
			this.repository = repository;
			this.memoryStore = memoryStore;
			this.lmdbStore = lmdbStore;
			this.lmdbStoreConfig = lmdbStoreConfig;
			this.dataDirectory = dataDirectory;
			this.deleteDataDirectory = deleteDataDirectory;
		}

		@Override
		public void close() throws IOException {
			try {
				repository.shutDown();
			} finally {
				if (deleteDataDirectory) {
					deleteDirectory(dataDirectory);
				}
			}
		}
	}
}
