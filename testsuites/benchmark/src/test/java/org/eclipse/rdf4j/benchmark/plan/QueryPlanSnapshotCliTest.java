/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.benchmark.plan;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.io.BufferedReader;
import java.io.ByteArrayOutputStream;
import java.io.PrintStream;
import java.io.StringReader;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.LinkedHashMap;
import java.util.Map;

import org.eclipse.rdf4j.benchmark.common.plan.QueryPlanCapture;
import org.eclipse.rdf4j.benchmark.common.plan.QueryPlanCaptureContext;
import org.eclipse.rdf4j.benchmark.common.plan.QueryPlanExplanation;
import org.eclipse.rdf4j.benchmark.common.plan.QueryPlanSnapshot;
import org.eclipse.rdf4j.benchmark.rio.util.ThemeDataSetGenerator.Theme;
import org.junit.jupiter.api.Test;

class QueryPlanSnapshotCliTest {

	@Test
	void parsesThemeQueryShortcutAndStore() {
		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--store", "memory",
				"--theme-query", "MEDICAL_RECORDS:3"
		});

		assertEquals(QueryPlanSnapshotCliOptions.StoreType.MEMORY, options.getStore());
		assertEquals(Theme.MEDICAL_RECORDS, options.getTheme());
		assertEquals(3, options.getQueryIndex());
	}

	@Test
	void parsesDirectQueryWithSystemPropertiesAndMetadata() {
		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--store", "lmdb",
				"--theme", "SOCIAL_MEDIA",
				"--query", "SELECT * WHERE { ?s ?p ?o }",
				"--property", "alpha=true",
				"-Dbeta=2",
				"--metadata", "run=local"
		});

		assertEquals(QueryPlanSnapshotCliOptions.StoreType.LMDB, options.getStore());
		assertEquals(Theme.SOCIAL_MEDIA, options.getTheme());
		assertEquals("SELECT * WHERE { ?s ?p ?o }", options.getQuery());
		assertEquals("true", options.getSystemProperties().get("alpha"));
		assertEquals("2", options.getSystemProperties().get("beta"));
		assertEquals("local", options.getMetadata().get("run"));
	}

	@Test
	void parsesRunAllThemeQueriesModeWithStore() {
		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--store", "memory",
				"--all-theme-queries"
		});

		assertEquals(QueryPlanSnapshotCliOptions.StoreType.MEMORY, options.getStore());
		assertTrue(options.runAllThemeQueries);
	}

	@Test
	void noInteractiveAllowsRunAllThemeQueriesWithStoreOnly() {
		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--no-interactive",
				"--store", "memory",
				"--all-theme-queries"
		});

		assertTrue(options.noInteractive);
		assertTrue(options.runAllThemeQueries);
		assertFalse(QueryPlanSnapshotCli.requiresInteractiveInput(options));
	}

	@Test
	void rejectsRunAllThemeQueriesWithSingleQueryFlags() {
		assertThrows(IllegalArgumentException.class, () -> QueryPlanSnapshotCli.parseArgs(new String[] {
				"--store", "memory",
				"--all-theme-queries",
				"--theme", "MEDICAL_RECORDS"
		}));
		assertThrows(IllegalArgumentException.class, () -> QueryPlanSnapshotCli.parseArgs(new String[] {
				"--store", "memory",
				"--all-theme-queries",
				"--query-id", "custom"
		}));
	}

	@Test
	void parsesCompareExistingModeAndIndexes() {
		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--compare-existing",
				"--query-id", "memory-medical-q0",
				"--compare-indices", "1,3"
		});

		assertTrue(options.compareExisting);
		assertEquals(1, options.compareIndices.leftIndex);
		assertEquals(3, options.compareIndices.rightIndex);
	}

	@Test
	void parsesPersistAndCompareLatestFlags() {
		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--store", "memory",
				"--theme", "MEDICAL_RECORDS",
				"--query-index", "0",
				"--persist", "false",
				"--compare-latest",
				"--diff-mode", "structure+estimates"
		});

		assertFalse(options.persist);
		assertTrue(options.compareLatest);
		assertEquals(QueryPlanSnapshotCliOptions.DiffMode.STRUCTURE_WITH_ESTIMATES, options.diffMode);
	}

	@Test
	void rejectsConflictingQueryInputs() {
		assertThrows(IllegalArgumentException.class, () -> QueryPlanSnapshotCli.parseArgs(new String[] {
				"--store", "memory",
				"--theme", "MEDICAL_RECORDS",
				"--query", "SELECT * WHERE { ?s ?p ?o }",
				"--query-index", "1"
		}));
	}

	@Test
	void detectsInteractiveFallbackWhenRequiredArgumentsMissing() {
		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--theme", "MEDICAL_RECORDS",
				"--query-index", "0"
		});

		assertTrue(QueryPlanSnapshotCli.requiresInteractiveInput(options));
	}

	@Test
	void noInteractiveRequiresCompleteArguments() {
		assertThrows(IllegalArgumentException.class, () -> QueryPlanSnapshotCli.parseArgs(new String[] {
				"--no-interactive",
				"--store", "memory",
				"--theme", "MEDICAL_RECORDS"
		}));
	}

	@Test
	void helpModeNeverRequiresInteractiveInput() {
		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] { "--help" });

		assertFalse(QueryPlanSnapshotCli.requiresInteractiveInput(options));
	}

	@Test
	void runModePrintsPrettyExplanationForAllLevels() throws Exception {
		ByteArrayOutputStream outputBuffer = new ByteArrayOutputStream();
		QueryPlanSnapshotCli cli = new QueryPlanSnapshotCli(new BufferedReader(new StringReader("")),
				new PrintStream(outputBuffer, true, StandardCharsets.UTF_8.name()));

		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--no-interactive",
				"--store", "memory",
				"--theme", "MEDICAL_RECORDS",
				"--query-index", "0",
				"--persist", "false"
		});

		cli.run(options);

		String printed = outputBuffer.toString(StandardCharsets.UTF_8);
		int unoptimizedIndex = printed.indexOf("=== Unoptimized Explanation ===");
		int optimizedIndex = printed.indexOf("=== Optimized Explanation ===");
		int executedIndex = printed.indexOf("=== Executed Explanation ===");
		assertTrue(unoptimizedIndex >= 0);
		assertTrue(optimizedIndex > unoptimizedIndex);
		assertTrue(executedIndex > optimizedIndex);
	}

	@Test
	void runModePrintsOriginalQueryAtStartOfResultsSection() throws Exception {
		String query = "SELECT * WHERE { ?s ?p ?o } LIMIT 5";
		ByteArrayOutputStream outputBuffer = new ByteArrayOutputStream();
		QueryPlanSnapshotCli cli = new QueryPlanSnapshotCli(new BufferedReader(new StringReader("")),
				new PrintStream(outputBuffer, true, StandardCharsets.UTF_8.name()));

		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--no-interactive",
				"--store", "memory",
				"--theme", "MEDICAL_RECORDS",
				"--query", query,
				"--persist", "false"
		});

		cli.run(options);

		String printed = outputBuffer.toString(StandardCharsets.UTF_8);
		int resultsIndex = printed.indexOf("=== Results ===");
		int originalQueryLabelIndex = printed.indexOf("Original query:");
		int queryIndex = printed.indexOf(query);
		int storeSummaryIndex = printed.indexOf("Store=memory");
		assertTrue(resultsIndex >= 0, printed);
		assertTrue(originalQueryLabelIndex > resultsIndex, printed);
		assertTrue(queryIndex > originalQueryLabelIndex, printed);
		assertTrue(storeSummaryIndex > queryIndex, printed);
	}

	@Test
	void interactiveRunAsksForQuerySourceBeforeTheme() throws Exception {
		String interactiveInput = String.join("\n",
				"memory",
				"manual",
				"MEDICAL_RECORDS",
				"SELECT * WHERE { ?s ?p ?o }",
				"END",
				"",
				"")
				+ "\n";
		ByteArrayOutputStream outputBuffer = new ByteArrayOutputStream();
		QueryPlanSnapshotCli cli = new QueryPlanSnapshotCli(new BufferedReader(new StringReader(interactiveInput)),
				new PrintStream(outputBuffer, true, StandardCharsets.UTF_8.name()));

		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] { "--persist", "false" });
		cli.run(options);

		String printed = outputBuffer.toString(StandardCharsets.UTF_8);
		int storeIndex = printed.indexOf("Store [memory|lmdb]");
		int querySourceIndex = printed.indexOf("Query source [themed|manual|file]");
		int themeIndex = printed.indexOf("Theme");
		assertTrue(storeIndex >= 0);
		assertTrue(querySourceIndex > storeIndex);
		assertTrue(themeIndex > querySourceIndex);
	}

	@Test
	void interactiveRunSupportsArrowKeySelectionForStore() throws Exception {
		String downArrow = "\u001B[B";
		String interactiveInput = String.join("\n",
				downArrow,
				downArrow,
				"MEDICAL_RECORDS",
				"SELECT * WHERE { ?s ?p ?o }",
				"END",
				"",
				"")
				+ "\n";
		ByteArrayOutputStream outputBuffer = new ByteArrayOutputStream();
		QueryPlanSnapshotCli cli = new QueryPlanSnapshotCli(new BufferedReader(new StringReader(interactiveInput)),
				new PrintStream(outputBuffer, true, StandardCharsets.UTF_8.name()));

		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] { "--persist", "false" });
		cli.run(options);

		String printed = outputBuffer.toString(StandardCharsets.UTF_8);
		assertTrue(printed.contains("Store=lmdb"), printed);
	}

	@Test
	void interactiveRunSupportsQueryFileSourceSelection() throws Exception {
		Path queryFile = Files.createTempFile("rdf4j-cli-query-", ".rq");
		Files.writeString(queryFile, "SELECT * WHERE { ?s ?p ?o } LIMIT 3", StandardCharsets.UTF_8);
		String interactiveInput = String.join("\n",
				"memory",
				"file",
				"MEDICAL_RECORDS",
				queryFile.toString(),
				"",
				"")
				+ "\n";
		ByteArrayOutputStream outputBuffer = new ByteArrayOutputStream();
		QueryPlanSnapshotCli cli = new QueryPlanSnapshotCli(new BufferedReader(new StringReader(interactiveInput)),
				new PrintStream(outputBuffer, true, StandardCharsets.UTF_8.name()));

		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] { "--persist", "false" });
		cli.run(options);

		String printed = outputBuffer.toString(StandardCharsets.UTF_8);
		assertTrue(printed.contains("Original query:"), printed);
		assertTrue(printed.contains("LIMIT 3"), printed);
	}

	@Test
	void interactiveNoArgsCanSelectCompareExistingModeAndCompare() throws Exception {
		Path outputDir = Files.createTempDirectory("rdf4j-cli-mode-compare-");
		writeSnapshot(outputDir, "q-mode", "fingerprint-mode", "2026-02-17T10:00:00Z");
		writeSnapshot(outputDir, "q-mode", "fingerprint-mode", "2026-02-17T10:05:00Z");

		String interactiveInput = String.join("\n",
				"compare existing runs",
				"query-id",
				outputDir.toString(),
				"q-mode",
				"structure+estimates",
				"enter indices",
				"0,1")
				+ "\n";
		ByteArrayOutputStream outputBuffer = new ByteArrayOutputStream();
		QueryPlanSnapshotCli cli = new QueryPlanSnapshotCli(new BufferedReader(new StringReader(interactiveInput)),
				new PrintStream(outputBuffer, true, StandardCharsets.UTF_8.name()));

		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {});
		cli.run(options);

		String printed = outputBuffer.toString(StandardCharsets.UTF_8);
		assertTrue(printed.contains("Compare:"), printed);
		assertTrue(printed.contains("diffMode: structure+estimates"), printed);
	}

	@Test
	void interactiveCompareExistingListsAllAvailableQueryIds() throws Exception {
		Path outputDir = Files.createTempDirectory("rdf4j-cli-query-list-");
		writeSnapshot(outputDir, "q-alpha", "fingerprint-alpha", "2026-02-17T10:00:00Z");
		writeSnapshot(outputDir, "q-alpha", "fingerprint-alpha", "2026-02-17T10:05:00Z");
		writeSnapshot(outputDir, "q-beta", "fingerprint-beta", "2026-02-17T10:10:00Z");

		String interactiveInput = String.join("\n",
				"compare existing runs",
				"query-id",
				outputDir.toString(),
				"q-alpha",
				"structure+estimates",
				"enter indices",
				"0,1")
				+ "\n";
		ByteArrayOutputStream outputBuffer = new ByteArrayOutputStream();
		QueryPlanSnapshotCli cli = new QueryPlanSnapshotCli(new BufferedReader(new StringReader(interactiveInput)),
				new PrintStream(outputBuffer, true, StandardCharsets.UTF_8.name()));

		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {});
		cli.run(options);

		String printed = outputBuffer.toString(StandardCharsets.UTF_8);
		assertTrue(printed.contains("q-alpha"), printed);
		assertTrue(printed.contains("q-beta"), printed);
	}

	@Test
	void interactiveCompareQueryIdPromptsOutputDirectoryOnceWhenBlank() throws Exception {
		Path outputDir = Files.createTempDirectory("rdf4j-cli-query-list-default-");
		writeSnapshot(outputDir, "q-alpha", "fingerprint-alpha", "2026-02-17T10:00:00Z");
		writeSnapshot(outputDir, "q-alpha", "fingerprint-alpha", "2026-02-17T10:05:00Z");
		String previousOutputDirectory = System.getProperty(QueryPlanCaptureContext.OUTPUT_DIRECTORY_PROPERTY);
		System.setProperty(QueryPlanCaptureContext.OUTPUT_DIRECTORY_PROPERTY, outputDir.toString());

		try {
			String interactiveInput = String.join("\n",
					"compare existing runs",
					"query-id",
					"",
					"q-alpha",
					"structure",
					"enter indices",
					"0,1")
					+ "\n";
			ByteArrayOutputStream outputBuffer = new ByteArrayOutputStream();
			QueryPlanSnapshotCli cli = new QueryPlanSnapshotCli(new BufferedReader(new StringReader(interactiveInput)),
					new PrintStream(outputBuffer, true, StandardCharsets.UTF_8.name()));

			QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {});
			cli.run(options);

			String printed = outputBuffer.toString(StandardCharsets.UTF_8);
			assertEquals(1, countOccurrences(printed, "Output directory (blank uses default):"), printed);
		} finally {
			if (previousOutputDirectory == null) {
				System.clearProperty(QueryPlanCaptureContext.OUTPUT_DIRECTORY_PROPERTY);
			} else {
				System.setProperty(QueryPlanCaptureContext.OUTPUT_DIRECTORY_PROPERTY, previousOutputDirectory);
			}
		}
	}

	@Test
	void compareExistingInteractiveModeCanBrowseAndViewRun() throws Exception {
		Path outputDir = Files.createTempDirectory("rdf4j-cli-runs-");
		writeSnapshot(outputDir, "q1", "fingerprint-a", "2026-02-17T10:00:00Z");
		writeSnapshot(outputDir, "q1", "fingerprint-a", "2026-02-17T10:05:00Z");

		String interactiveInput = String.join("\n",
				"1",
				"1",
				"3")
				+ "\n";
		ByteArrayOutputStream outputBuffer = new ByteArrayOutputStream();
		QueryPlanSnapshotCli cli = new QueryPlanSnapshotCli(new BufferedReader(new StringReader(interactiveInput)),
				new PrintStream(outputBuffer, true, StandardCharsets.UTF_8.name()));

		QueryPlanSnapshotCliOptions options = QueryPlanSnapshotCli.parseArgs(new String[] {
				"--compare-existing",
				"--output-dir", outputDir.toString(),
				"--query-id", "q1"
		});
		cli.run(options);

		String printed = outputBuffer.toString(StandardCharsets.UTF_8);
		assertTrue(printed.contains("Run details:"), printed);
		assertFalse(printed.contains("[1] [0]"), printed);
	}

	private static int countOccurrences(String value, String token) {
		int count = 0;
		int fromIndex = 0;
		while (true) {
			int next = value.indexOf(token, fromIndex);
			if (next < 0) {
				return count;
			}
			count++;
			fromIndex = next + token.length();
		}
	}

	private static void writeSnapshot(Path outputDir, String queryId, String fingerprint, String capturedAt)
			throws Exception {
		QueryPlanCapture capture = new QueryPlanCapture();
		QueryPlanSnapshot snapshot = new QueryPlanSnapshot();
		snapshot.setFormatVersion("1");
		snapshot.setCapturedAt(capturedAt);
		snapshot.setQueryId(queryId);
		snapshot.setQueryString("SELECT * WHERE { ?s ?p ?o }");
		snapshot.setUnoptimizedFingerprint(fingerprint);
		snapshot.setMetadata(Map.of("store", "memory"));
		snapshot.setFeatureFlags(Map.of("flagA", "true"));
		QueryPlanExplanation explanation = new QueryPlanExplanation();
		explanation.setLevel("UNOPTIMIZED");
		explanation.setExplanationText("Plan text");
		LinkedHashMap<String, QueryPlanExplanation> explanations = new LinkedHashMap<>();
		explanations.put("unoptimized", explanation);
		snapshot.setExplanations(explanations);
		capture.writeSnapshot(outputDir.resolve(queryId + "-" + capturedAt.replace(":", "-") + ".json"), snapshot);
	}
}
