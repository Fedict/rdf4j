/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.benchmark.plan;

import static org.junit.jupiter.api.Assertions.assertTrue;

import java.io.ByteArrayOutputStream;
import java.io.PrintStream;
import java.nio.charset.StandardCharsets;
import java.util.LinkedHashMap;

import org.eclipse.rdf4j.benchmark.common.plan.QueryPlanExplanation;
import org.eclipse.rdf4j.benchmark.common.plan.QueryPlanSnapshot;
import org.junit.jupiter.api.Test;

class QueryPlanSnapshotComparatorTest {

	@Test
	void semanticDiffIgnoresEstimateOnlyChangesByDefault() {
		QueryPlanSnapshot left = snapshotWithOptimizedJson(explanationJson(1.0, 2.0, 7));
		QueryPlanSnapshot right = snapshotWithOptimizedJson(explanationJson(99.0, 88.0, 7));

		ByteArrayOutputStream capture = new ByteArrayOutputStream();
		QueryPlanSnapshotComparator.printComparison(new PrintStream(capture), run(left), run(right));

		String output = capture.toString(StandardCharsets.UTF_8);
		assertTrue(output.contains("structure=same"));
		assertTrue(output.contains("joinAlgorithms=same"));
		assertTrue(output.contains("actualResultSizes=same"));
		assertTrue(output.contains("estimates=ignored"));
	}

	@Test
	void semanticDiffCanIncludeEstimateChanges() {
		QueryPlanSnapshot left = snapshotWithOptimizedJson(explanationJson(1.0, 2.0, 7));
		QueryPlanSnapshot right = snapshotWithOptimizedJson(explanationJson(99.0, 88.0, 7));

		ByteArrayOutputStream capture = new ByteArrayOutputStream();
		QueryPlanSnapshotComparator.printComparison(new PrintStream(capture), run(left), run(right),
				QueryPlanSnapshotCliOptions.DiffMode.STRUCTURE_WITH_ESTIMATES);

		String output = capture.toString(StandardCharsets.UTF_8);
		assertTrue(output.contains("actualResultSizes=same"));
		assertTrue(output.contains("estimates=diff"));
	}

	@Test
	void printRunDetailsIncludesFullExplanationText() {
		QueryPlanExplanation explanation = new QueryPlanExplanation();
		explanation.setLevel("optimized");
		explanation.setTupleExprJson("tuple-expr");
		explanation.setIrRenderedQuery("SELECT * WHERE { ?s ?p ?o }");
		explanation
				.setExplanationText("line-01-abcdefghij\nline-02-abcdefghij\nline-03-abcdefghij\nline-04-abcdefghij\n"
						+ "line-05-abcdefghij\nline-06-abcdefghij\nline-07-abcdefghij\nline-08-abcdefghij\n"
						+ "line-09-abcdefghij\nline-10-abcdefghij\nline-11-abcdefghij\nline-12-abcdefghij\n"
						+ "line-13-abcdefghij\nline-14-abcdefghij\nline-15-abcdefghij\nline-16-abcdefghij\n"
						+ "line-17-abcdefghij\nline-18-abcdefghij\nline-19-abcdefghij\nline-20-tail-marker");

		QueryPlanSnapshot snapshot = new QueryPlanSnapshot();
		snapshot.setCapturedAt("2026-02-17T10:00:00Z");
		snapshot.setQueryId("q0");
		snapshot.setQueryString("SELECT * WHERE { ?s ?p ?o }");
		snapshot.setUnoptimizedFingerprint("abc123");
		LinkedHashMap<String, QueryPlanExplanation> explanations = new LinkedHashMap<>();
		explanations.put("optimized", explanation);
		snapshot.setExplanations(explanations);

		ByteArrayOutputStream capture = new ByteArrayOutputStream();
		QueryPlanSnapshotComparator.printRunDetails(new PrintStream(capture),
				QueryPlanSnapshotComparator.inMemoryRun(snapshot));

		String output = capture.toString(StandardCharsets.UTF_8);
		assertTrue(output.contains("line-20-tail-marker"), output);
	}

	private static QueryPlanSnapshotComparator.SnapshotRun run(QueryPlanSnapshot snapshot) {
		return QueryPlanSnapshotComparator.inMemoryRun(snapshot);
	}

	private static QueryPlanSnapshot snapshotWithOptimizedJson(String explanationJson) {
		QueryPlanExplanation explanation = new QueryPlanExplanation();
		explanation.setLevel("optimized");
		explanation.setExplanationJson(explanationJson);
		explanation.setTupleExprJson("tuple-expr");
		explanation.setIrRenderedQuery("SELECT * WHERE { ?s ?p ?o }");

		QueryPlanSnapshot snapshot = new QueryPlanSnapshot();
		snapshot.setCapturedAt("2026-02-17T10:00:00Z");
		snapshot.setQueryId("q0");
		snapshot.setQueryString("SELECT * WHERE { ?s ?p ?o }");
		snapshot.setUnoptimizedFingerprint("abc123");
		LinkedHashMap<String, QueryPlanExplanation> explanations = new LinkedHashMap<>();
		explanations.put("optimized", explanation);
		snapshot.setExplanations(explanations);
		return snapshot;
	}

	private static String explanationJson(double costEstimate, double resultSizeEstimate, int resultSizeActual) {
		return "{\n"
				+ "  \"type\": \"Join\",\n"
				+ "  \"algorithm\": \"HashJoinIteration\",\n"
				+ "  \"costEstimate\": " + costEstimate + ",\n"
				+ "  \"resultSizeEstimate\": " + resultSizeEstimate + ",\n"
				+ "  \"resultSizeActual\": " + resultSizeActual + ",\n"
				+ "  \"plans\": [\n"
				+ "    {\"type\": \"StatementPattern\", \"resultSizeActual\": 3},\n"
				+ "    {\"type\": \"StatementPattern\", \"resultSizeActual\": 4}\n"
				+ "  ]\n"
				+ "}";
	}
}
