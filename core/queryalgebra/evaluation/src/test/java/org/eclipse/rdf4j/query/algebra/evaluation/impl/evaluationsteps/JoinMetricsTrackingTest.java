/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl.evaluationsteps;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.Collections;
import java.util.List;

import org.eclipse.rdf4j.common.iteration.CloseableIteration;
import org.eclipse.rdf4j.common.iteration.CloseableIteratorIteration;
import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.algebra.Join;
import org.eclipse.rdf4j.query.algebra.SingletonSet;
import org.eclipse.rdf4j.query.algebra.StatementPattern;
import org.eclipse.rdf4j.query.algebra.Var;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryEvaluationStep;
import org.eclipse.rdf4j.query.explanation.TelemetryMetricNames;
import org.eclipse.rdf4j.query.impl.EmptyBindingSet;
import org.junit.jupiter.api.Test;

class JoinMetricsTrackingTest {

	@Test
	void doesNotCollectTelemetryWhenRuntimeTrackingIsDisabled() {
		Join joinNode = new Join(new SingletonSet(), new SingletonSet());
		StatementPattern rightNode = new StatementPattern(Var.of("s"), Var.of("p"), Var.of("o"));
		QueryEvaluationStep wrapped = JoinMetricsTracking.wrapRightInput(delegateProducing(3), joinNode, rightNode,
				false);

		try (CloseableIteration<BindingSet> iteration = wrapped.evaluate(EmptyBindingSet.getInstance())) {
			consume(iteration);
		}

		assertThat(joinNode.getJoinRightIteratorsCreatedActual()).isEqualTo(-1);
		assertThat(joinNode.getJoinLeftBindingsConsumedActual()).isEqualTo(-1);
		assertThat(joinNode.getJoinRightBindingsConsumedActual()).isEqualTo(-1);
		assertThat(rightNode.getJoinRightIteratorsCreatedActual()).isEqualTo(-1);
		assertThat(rightNode.getJoinLeftBindingsConsumedActual()).isEqualTo(-1);
		assertThat(rightNode.getJoinRightBindingsConsumedActual()).isEqualTo(-1);
	}

	@Test
	void doesNotCollectTelemetryFromStaleNodeMetricsWithoutActiveTracking() {
		Join joinNode = new Join(new SingletonSet(), new SingletonSet());
		joinNode.setResultSizeActual(42);
		StatementPattern rightNode = new StatementPattern(Var.of("s"), Var.of("p"), Var.of("o"));
		rightNode.setResultSizeActual(7);
		QueryEvaluationStep wrapped = JoinMetricsTracking.wrapRightInput(delegateProducing(3), joinNode, rightNode,
				false);

		try (CloseableIteration<BindingSet> iteration = wrapped.evaluate(EmptyBindingSet.getInstance())) {
			consume(iteration);
		}

		assertThat(joinNode.getResultSizeActual()).isEqualTo(42);
		assertThat(rightNode.getResultSizeActual()).isEqualTo(7);
		assertThat(joinNode.getJoinRightIteratorsCreatedActual()).isEqualTo(-1);
		assertThat(joinNode.getJoinLeftBindingsConsumedActual()).isEqualTo(-1);
		assertThat(joinNode.getJoinRightBindingsConsumedActual()).isEqualTo(-1);
		assertThat(rightNode.getJoinRightIteratorsCreatedActual()).isEqualTo(-1);
		assertThat(rightNode.getJoinLeftBindingsConsumedActual()).isEqualTo(-1);
		assertThat(rightNode.getJoinRightBindingsConsumedActual()).isEqualTo(-1);
	}

	@Test
	void doesNotCollectTelemetryWhenRuntimeTelemetryFlagIsDisabledOnNodes() {
		Join joinNode = new Join(new SingletonSet(), new SingletonSet());
		joinNode.setRuntimeTelemetryEnabled(false);
		joinNode.setResultSizeActual(0);
		joinNode.setTotalTimeNanosActual(0);
		StatementPattern rightNode = new StatementPattern(Var.of("s"), Var.of("p"), Var.of("o"));
		rightNode.setRuntimeTelemetryEnabled(false);
		rightNode.setResultSizeActual(0);
		rightNode.setHasNextCallCountActual(0);
		QueryEvaluationStep wrapped = JoinMetricsTracking.wrapRightInput(delegateProducing(3), joinNode, rightNode,
				true);

		try (CloseableIteration<BindingSet> iteration = wrapped.evaluate(EmptyBindingSet.getInstance())) {
			consume(iteration);
		}

		assertThat(joinNode.getJoinRightIteratorsCreatedActual()).isEqualTo(-1);
		assertThat(joinNode.getJoinLeftBindingsConsumedActual()).isEqualTo(-1);
		assertThat(joinNode.getJoinRightBindingsConsumedActual()).isEqualTo(-1);
		assertThat(rightNode.getJoinRightIteratorsCreatedActual()).isEqualTo(-1);
		assertThat(rightNode.getJoinLeftBindingsConsumedActual()).isEqualTo(-1);
		assertThat(rightNode.getJoinRightBindingsConsumedActual()).isEqualTo(-1);
	}

	@Test
	void collectsTelemetryWhenRuntimeTrackingIsEnabled() {
		Join joinNode = new Join(new SingletonSet(), new SingletonSet());
		joinNode.setResultSizeActual(0);
		joinNode.setRuntimeTelemetryEnabled(true);
		StatementPattern rightNode = new StatementPattern(Var.of("s"), Var.of("p"), Var.of("o"));
		rightNode.setRuntimeTelemetryEnabled(true);
		QueryEvaluationStep wrapped = JoinMetricsTracking.wrapRightInput(delegateProducing(3), joinNode, rightNode,
				true);

		try (CloseableIteration<BindingSet> iteration = wrapped.evaluate(EmptyBindingSet.getInstance())) {
			consume(iteration);
		}

		assertThat(joinNode.getJoinRightIteratorsCreatedActual()).isEqualTo(1);
		assertThat(joinNode.getJoinLeftBindingsConsumedActual()).isEqualTo(0);
		assertThat(joinNode.getJoinRightBindingsConsumedActual()).isEqualTo(3);
		assertThat(rightNode.getJoinRightIteratorsCreatedActual()).isEqualTo(1);
		assertThat(rightNode.getJoinLeftBindingsConsumedActual()).isEqualTo(1);
		assertThat(rightNode.getJoinRightBindingsConsumedActual()).isEqualTo(3);
	}

	@Test
	void recordsEmptyRightProbeTelemetryWhenRightSideReturnsEmptyIteration() {
		Join joinNode = new Join(new SingletonSet(), new SingletonSet());
		joinNode.setResultSizeActual(0);
		joinNode.setRuntimeTelemetryEnabled(true);
		StatementPattern rightNode = new StatementPattern(Var.of("s"), Var.of("p"), Var.of("o"));
		QueryEvaluationStep wrapped = JoinMetricsTracking.wrapRightInput(
				bindings -> QueryEvaluationStep.EMPTY_ITERATION,
				joinNode, rightNode, true);

		try (CloseableIteration<BindingSet> iteration = wrapped.evaluate(EmptyBindingSet.getInstance())) {
			consume(iteration);
		}

		assertThat(joinNode.getJoinRightIteratorsCreatedActual()).isEqualTo(1);
		assertThat(joinNode.getJoinRightBindingsConsumedActual()).isEqualTo(0);
		assertThat(joinNode.getLongMetricActual(TelemetryMetricNames.EMPTY_RIGHT_PROBE_COUNT_ACTUAL)).isEqualTo(1);
		assertThat(joinNode.getLongMetricActual(TelemetryMetricNames.LEFT_ROWS_WITH_MATCH_ACTUAL)).isLessThan(1);
		assertThat(rightNode.getJoinLeftBindingsConsumedActual()).isEqualTo(1);
		assertThat(rightNode.getJoinRightBindingsConsumedActual()).isEqualTo(0);
	}

	private static QueryEvaluationStep delegateProducing(int rowCount) {
		List<BindingSet> rows = Collections.nCopies(rowCount, EmptyBindingSet.getInstance());
		return bindings -> new CloseableIteratorIteration<>(rows.iterator());
	}

	private static void consume(CloseableIteration<BindingSet> iteration) {
		while (iteration.hasNext()) {
			iteration.next();
		}
	}
}
