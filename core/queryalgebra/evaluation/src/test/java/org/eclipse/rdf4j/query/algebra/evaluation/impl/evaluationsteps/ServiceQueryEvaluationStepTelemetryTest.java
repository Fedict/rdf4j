/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl.evaluationsteps;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anySet;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

import java.util.Collections;
import java.util.List;
import java.util.concurrent.locks.LockSupport;

import org.eclipse.rdf4j.common.iteration.CloseableIteration;
import org.eclipse.rdf4j.common.iteration.CloseableIteratorIteration;
import org.eclipse.rdf4j.model.Value;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.algebra.Service;
import org.eclipse.rdf4j.query.algebra.SingletonSet;
import org.eclipse.rdf4j.query.algebra.StatementPattern;
import org.eclipse.rdf4j.query.algebra.Var;
import org.eclipse.rdf4j.query.algebra.evaluation.federation.FederatedService;
import org.eclipse.rdf4j.query.algebra.evaluation.federation.FederatedServiceResolver;
import org.eclipse.rdf4j.query.explanation.TelemetryMetricNames;
import org.eclipse.rdf4j.query.impl.EmptyBindingSet;
import org.eclipse.rdf4j.query.impl.MapBindingSet;
import org.junit.jupiter.api.Test;

class ServiceQueryEvaluationStepTelemetryTest {

	@Test
	void recordsLatencyQuantilesForAskRequests() {
		Service service = new Service(
				new Var("serviceRef", SimpleValueFactory.getInstance().createIRI("http://example.com/service")),
				new SingletonSet(),
				"{ VALUES ?x { 1 } }",
				Collections.emptyMap(),
				null,
				false);
		service.setRuntimeTelemetryEnabled(true);

		FederatedService federatedService = mock(FederatedService.class);
		when(federatedService.ask(eq(service), any(BindingSet.class), eq(service.getBaseURI())))
				.thenAnswer(invocation -> {
					LockSupport.parkNanos(1_000_000L);
					return true;
				});

		FederatedServiceResolver resolver = mock(FederatedServiceResolver.class);
		when(resolver.getService("http://example.com/service")).thenReturn(federatedService);

		MapBindingSet bindings = new MapBindingSet();
		bindings.addBinding("x", SimpleValueFactory.getInstance().createLiteral("1"));

		ServiceQueryEvaluationStep step = new ServiceQueryEvaluationStep(service, service.getServiceRef(), resolver);
		try (CloseableIteration<BindingSet> result = step.evaluate(bindings)) {
			assertThat(result.hasNext()).isTrue();
			BindingSet row = result.next();
			assertThat(row.getValue("x")).isEqualTo(bindings.getValue("x"));
			assertThat(row.getValue("serviceRef")).isEqualTo(service.getServiceRef().getValue());
			assertThat(result.hasNext()).isFalse();
		}

		assertThat(service.getLongMetricActual(TelemetryMetricNames.REMOTE_REQUEST_COUNT_ACTUAL)).isEqualTo(1L);
		assertThat(service.getLongMetricActual(TelemetryMetricNames.REMOTE_ASK_REQUEST_COUNT_ACTUAL)).isEqualTo(1L);
		assertThat(service.getLongMetricActual(TelemetryMetricNames.REMOTE_LATENCY_TOTAL_NANOS_ACTUAL))
				.isGreaterThan(0L);
		assertThat(service.getDoubleMetricActual(TelemetryMetricNames.REMOTE_LATENCY_P50_NANOS_ACTUAL))
				.isGreaterThan(0D);
		assertThat(service.getDoubleMetricActual(TelemetryMetricNames.REMOTE_LATENCY_P95_NANOS_ACTUAL))
				.isGreaterThan(0D);
	}

	@Test
	void recordsLatencyQuantilesForSelectRequests() {
		Service service = new Service(
				new Var("serviceRef", SimpleValueFactory.getInstance().createIRI("http://example.com/service")),
				new StatementPattern(Var.of("s"), Var.of("p"), Var.of("o")),
				"{ ?s ?p ?o }",
				Collections.emptyMap(),
				null,
				false);
		service.setRuntimeTelemetryEnabled(true);

		FederatedService federatedService = mock(FederatedService.class);
		when(federatedService.select(eq(service), anySet(), any(BindingSet.class),
				eq(service.getBaseURI())))
				.thenAnswer(invocation -> {
					LockSupport.parkNanos(1_000_000L);
					return new CloseableIteratorIteration<>(List.of(singleBindingSet("s", "row")).iterator());
				});

		FederatedServiceResolver resolver = mock(FederatedServiceResolver.class);
		when(resolver.getService("http://example.com/service")).thenReturn(federatedService);

		ServiceQueryEvaluationStep step = new ServiceQueryEvaluationStep(service, service.getServiceRef(), resolver);
		try (CloseableIteration<BindingSet> result = step.evaluate(EmptyBindingSet.getInstance())) {
			while (result.hasNext()) {
				result.next();
			}
		}

		assertThat(service.getLongMetricActual(TelemetryMetricNames.REMOTE_REQUEST_COUNT_ACTUAL)).isEqualTo(1L);
		assertThat(service.getLongMetricActual(TelemetryMetricNames.REMOTE_SELECT_REQUEST_COUNT_ACTUAL)).isEqualTo(1L);
		assertThat(service.getLongMetricActual(TelemetryMetricNames.REMOTE_BYTES_RECEIVED_ACTUAL)).isGreaterThan(0L);
		assertThat(service.getLongMetricActual(TelemetryMetricNames.REMOTE_LATENCY_TOTAL_NANOS_ACTUAL))
				.isGreaterThan(0L);
		assertThat(service.getDoubleMetricActual(TelemetryMetricNames.REMOTE_LATENCY_P50_NANOS_ACTUAL))
				.isGreaterThan(0D);
		assertThat(service.getDoubleMetricActual(TelemetryMetricNames.REMOTE_LATENCY_P95_NANOS_ACTUAL))
				.isGreaterThan(0D);
	}

	@Test
	void skipsRequestAndResponseByteAccountingWhenRuntimeTelemetryDisabled() {
		Service service = new Service(
				new Var("serviceRef", SimpleValueFactory.getInstance().createIRI("http://example.com/service")),
				new StatementPattern(Var.of("s"), Var.of("p"), Var.of("o")),
				"{ ?s ?p ?o }",
				Collections.emptyMap(),
				null,
				false);
		service.setRuntimeTelemetryEnabled(false);

		FederatedService federatedService = mock(FederatedService.class);
		BindingSet responseRow = mock(BindingSet.class);
		when(responseRow.toString()).thenThrow(new AssertionError("response byte accounting should be disabled"));
		when(federatedService.select(eq(service), anySet(), any(BindingSet.class),
				eq(service.getBaseURI())))
				.thenReturn(new CloseableIteratorIteration<>(List.of(responseRow).iterator()));

		FederatedServiceResolver resolver = mock(FederatedServiceResolver.class);
		when(resolver.getService("http://example.com/service")).thenReturn(federatedService);

		Value requestValue = mock(Value.class);
		when(requestValue.stringValue()).thenReturn("request-value");
		when(requestValue.toString()).thenThrow(new AssertionError("request byte accounting should be disabled"));
		MapBindingSet bindings = new MapBindingSet();
		bindings.addBinding("input", requestValue);

		ServiceQueryEvaluationStep step = new ServiceQueryEvaluationStep(service, service.getServiceRef(), resolver);
		try (CloseableIteration<BindingSet> result = step.evaluate(bindings)) {
			assertThat(result.hasNext()).isTrue();
			assertThat(result.next()).isSameAs(responseRow);
			assertThat(result.hasNext()).isFalse();
		}

		assertThat(service.getLongMetricActual(TelemetryMetricNames.REMOTE_BYTES_SENT_ACTUAL)).isEqualTo(-1L);
		assertThat(service.getLongMetricActual(TelemetryMetricNames.REMOTE_BYTES_RECEIVED_ACTUAL)).isEqualTo(-1L);
	}

	private static BindingSet singleBindingSet(String name, String value) {
		MapBindingSet bindingSet = new MapBindingSet();
		bindingSet.addBinding(name, SimpleValueFactory.getInstance().createLiteral(value));
		return bindingSet;
	}
}
