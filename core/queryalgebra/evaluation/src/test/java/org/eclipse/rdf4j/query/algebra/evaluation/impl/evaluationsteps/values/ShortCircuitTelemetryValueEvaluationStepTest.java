/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl.evaluationsteps.values;

import static org.assertj.core.api.Assertions.assertThat;

import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;

import org.eclipse.rdf4j.model.impl.BooleanLiteral;
import org.eclipse.rdf4j.query.algebra.And;
import org.eclipse.rdf4j.query.algebra.If;
import org.eclipse.rdf4j.query.algebra.Or;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryValueEvaluationStep;
import org.eclipse.rdf4j.query.explanation.TelemetryMetricNames;
import org.eclipse.rdf4j.query.impl.EmptyBindingSet;
import org.junit.jupiter.api.Test;

class ShortCircuitTelemetryValueEvaluationStepTest {

	@Test
	void andRecordsShortCircuitWhenLeftArgFalse() {
		And andNode = new And();
		andNode.setRuntimeTelemetryEnabled(true);
		AtomicInteger rightEvaluations = new AtomicInteger();

		QueryValueEvaluationStep step = AndValueEvaluationStep.supply(
				bindings -> BooleanLiteral.FALSE,
				bindings -> {
					rightEvaluations.incrementAndGet();
					return BooleanLiteral.TRUE;
				},
				andNode);

		assertThat(step.evaluate(EmptyBindingSet.getInstance())).isEqualTo(BooleanLiteral.FALSE);
		assertThat(rightEvaluations).hasValue(0);
		assertThat(andNode.getLongMetricActual(TelemetryMetricNames.SHORT_CIRCUIT_COUNT_ACTUAL)).isEqualTo(1L);
	}

	@Test
	void orRecordsShortCircuitWhenLeftArgTrue() {
		Or orNode = new Or();
		orNode.setRuntimeTelemetryEnabled(true);
		AtomicInteger rightEvaluations = new AtomicInteger();

		OrValueEvaluationStep step = new OrValueEvaluationStep(
				bindings -> BooleanLiteral.TRUE,
				bindings -> {
					rightEvaluations.incrementAndGet();
					return BooleanLiteral.FALSE;
				},
				orNode);

		assertThat(step.evaluate(EmptyBindingSet.getInstance())).isEqualTo(BooleanLiteral.TRUE);
		assertThat(rightEvaluations).hasValue(0);
		assertThat(orNode.getLongMetricActual(TelemetryMetricNames.SHORT_CIRCUIT_COUNT_ACTUAL)).isEqualTo(1L);
	}

	@Test
	void ifRecordsShortCircuitWhenSkippingBranch() {
		If ifNode = new If();
		ifNode.setRuntimeTelemetryEnabled(true);
		AtomicBoolean condition = new AtomicBoolean(true);
		AtomicInteger resultEvaluations = new AtomicInteger();
		AtomicInteger alternativeEvaluations = new AtomicInteger();

		IfValueEvaluationStep step = new IfValueEvaluationStep(
				bindings -> {
					resultEvaluations.incrementAndGet();
					return BooleanLiteral.TRUE;
				},
				bindings -> BooleanLiteral.valueOf(condition.get()),
				bindings -> {
					alternativeEvaluations.incrementAndGet();
					return BooleanLiteral.FALSE;
				},
				ifNode);

		assertThat(step.evaluate(EmptyBindingSet.getInstance())).isEqualTo(BooleanLiteral.TRUE);
		condition.set(false);
		assertThat(step.evaluate(EmptyBindingSet.getInstance())).isEqualTo(BooleanLiteral.FALSE);

		assertThat(resultEvaluations).hasValue(1);
		assertThat(alternativeEvaluations).hasValue(1);
		assertThat(ifNode.getLongMetricActual(TelemetryMetricNames.SHORT_CIRCUIT_COUNT_ACTUAL)).isEqualTo(2L);
	}
}
