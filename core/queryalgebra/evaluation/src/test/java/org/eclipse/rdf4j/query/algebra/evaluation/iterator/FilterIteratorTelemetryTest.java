/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.iterator;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

import java.util.List;

import org.eclipse.rdf4j.common.iteration.CloseableIteratorIteration;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.algebra.Filter;
import org.eclipse.rdf4j.query.algebra.SingletonSet;
import org.eclipse.rdf4j.query.algebra.ValueConstant;
import org.eclipse.rdf4j.query.algebra.evaluation.EvaluationStrategy;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryValueEvaluationStep;
import org.eclipse.rdf4j.query.impl.MapBindingSet;
import org.junit.jupiter.api.Test;

class FilterIteratorTelemetryTest {

	@Test
	void skipsTelemetryCountersWhenRuntimeTelemetryDisabled() throws Exception {
		Filter filter = new Filter(new SingletonSet(),
				new ValueConstant(SimpleValueFactory.getInstance().createLiteral(true)));
		filter.setRuntimeTelemetryEnabled(false);

		QueryValueEvaluationStep condition = mock(QueryValueEvaluationStep.class);
		EvaluationStrategy strategy = mock(EvaluationStrategy.class);
		when(strategy.isTrue(eq(condition), any(BindingSet.class))).thenReturn(true);

		BindingSet row = singleBindingSet("x", "1");
		FilterIterator iterator = new FilterIterator(filter,
				new CloseableIteratorIteration<>(List.of(row).iterator()),
				condition,
				strategy);
		try (iterator) {
			assertThat(iterator.hasNext()).isTrue();
			assertThat(iterator.next()).isSameAs(row);
			assertThat(iterator.hasNext()).isFalse();
		}

		assertThat(iterator.getSourceRowsScannedActual()).isZero();
		assertThat(iterator.getSourceRowsMatchedActual()).isZero();
		assertThat(iterator.getSourceRowsFilteredActual()).isZero();
	}

	private static BindingSet singleBindingSet(String name, String value) {
		MapBindingSet bindingSet = new MapBindingSet();
		bindingSet.addBinding(name, SimpleValueFactory.getInstance().createLiteral(value));
		return bindingSet;
	}
}
