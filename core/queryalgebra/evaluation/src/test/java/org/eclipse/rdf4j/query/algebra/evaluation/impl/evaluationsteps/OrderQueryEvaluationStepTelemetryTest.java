/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl.evaluationsteps;

import static org.assertj.core.api.Assertions.assertThat;

import java.lang.reflect.Field;
import java.util.Comparator;
import java.util.List;

import org.eclipse.rdf4j.common.iteration.CloseableIteration;
import org.eclipse.rdf4j.common.iteration.CloseableIteratorIteration;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.algebra.Order;
import org.eclipse.rdf4j.query.algebra.SingletonSet;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryEvaluationStep;
import org.eclipse.rdf4j.query.algebra.evaluation.iterator.OrderIterator;
import org.eclipse.rdf4j.query.explanation.TelemetryMetricNames;
import org.eclipse.rdf4j.query.impl.EmptyBindingSet;
import org.eclipse.rdf4j.query.impl.MapBindingSet;
import org.junit.jupiter.api.Test;

class OrderQueryEvaluationStepTelemetryTest {

	@Test
	void retainsLegacyConstructorForBinaryCompatibility() throws Exception {
		assertThat(OrderQueryEvaluationStep.class
				.getConstructor(Comparator.class, long.class, boolean.class, QueryEvaluationStep.class, long.class))
				.isNotNull();
	}

	@Test
	void usesBaseComparatorWhenRuntimeTelemetryDisabled() throws Exception {
		Order order = new Order(new SingletonSet());
		order.setRuntimeTelemetryEnabled(false);

		Comparator<BindingSet> baseComparator = Comparator.comparingInt(BindingSet::size);
		QueryEvaluationStep preparedArg = ignored -> new CloseableIteratorIteration<>(
				List.of(singleBindingSet("x", "2"), singleBindingSet("x", "1")).iterator());

		OrderQueryEvaluationStep step = new OrderQueryEvaluationStep(order, baseComparator, Long.MAX_VALUE, false,
				preparedArg, Integer.MAX_VALUE);
		try (CloseableIteration<BindingSet> result = step.evaluate(EmptyBindingSet.getInstance())) {
			assertThat(extractComparator(result)).isSameAs(baseComparator);
			while (result.hasNext()) {
				result.next();
			}
		}

		assertThat(order.getLongMetricActual(TelemetryMetricNames.SORT_COMPARISONS_ACTUAL)).isEqualTo(-1L);
	}

	@SuppressWarnings("unchecked")
	private static Comparator<BindingSet> extractComparator(CloseableIteration<BindingSet> iteration)
			throws NoSuchFieldException, IllegalAccessException {
		Field comparatorField = OrderIterator.class.getDeclaredField("comparator");
		comparatorField.setAccessible(true);
		return (Comparator<BindingSet>) comparatorField.get(iteration);
	}

	private static BindingSet singleBindingSet(String name, String value) {
		MapBindingSet bindingSet = new MapBindingSet();
		bindingSet.addBinding(name, SimpleValueFactory.getInstance().createLiteral(value));
		return bindingSet;
	}
}
