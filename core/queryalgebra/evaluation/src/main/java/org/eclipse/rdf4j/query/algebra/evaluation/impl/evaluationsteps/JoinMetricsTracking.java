/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.algebra.evaluation.impl.evaluationsteps;

import org.eclipse.rdf4j.common.iteration.CloseableIteration;
import org.eclipse.rdf4j.common.iteration.IterationWrapper;
import org.eclipse.rdf4j.query.BindingSet;
import org.eclipse.rdf4j.query.QueryEvaluationException;
import org.eclipse.rdf4j.query.algebra.QueryModelNode;
import org.eclipse.rdf4j.query.algebra.evaluation.QueryEvaluationStep;
import org.eclipse.rdf4j.query.explanation.TelemetryMetricNames;

final class JoinMetricsTracking {

	private JoinMetricsTracking() {
	}

	static QueryEvaluationStep wrapLeftInput(QueryEvaluationStep delegate, QueryModelNode joinNode,
			QueryModelNode leftNode, boolean runtimeTelemetryTrackingActive) {
		return wrap(delegate, joinNode, leftNode, false, runtimeTelemetryTrackingActive);
	}

	static QueryEvaluationStep wrapRightInput(QueryEvaluationStep delegate, QueryModelNode joinNode,
			QueryModelNode rightNode, boolean runtimeTelemetryTrackingActive) {
		return wrap(delegate, joinNode, rightNode, true, runtimeTelemetryTrackingActive);
	}

	private static QueryEvaluationStep wrap(QueryEvaluationStep delegate, QueryModelNode joinNode,
			QueryModelNode sideNode,
			boolean rightSide, boolean runtimeTelemetryTrackingActive) {
		return bindings -> {
			if (!runtimeTelemetryTrackingActive) {
				return delegate.evaluate(bindings);
			}
			if (!runtimeTelemetryEnabled(joinNode) && !runtimeTelemetryEnabled(sideNode)) {
				return delegate.evaluate(bindings);
			}

			initializeJoinMetrics(joinNode);
			initializeJoinMetrics(sideNode);
			if (rightSide) {
				joinNode.setJoinRightIteratorsCreatedActual(joinNode.getJoinRightIteratorsCreatedActual() + 1);
				if (sideNode != null) {
					sideNode.setJoinRightIteratorsCreatedActual(sideNode.getJoinRightIteratorsCreatedActual() + 1);
					sideNode.setJoinLeftBindingsConsumedActual(sideNode.getJoinLeftBindingsConsumedActual() + 1);
				}
			}

			CloseableIteration<BindingSet> base = delegate.evaluate(bindings);
			if (base == QueryEvaluationStep.EMPTY_ITERATION) {
				recordProbeTelemetry(joinNode, sideNode, rightSide, 0L);
				return base;
			}

			return new IterationWrapper<>(base) {
				private long consumedBindings;
				private boolean flushed;

				@Override
				public BindingSet next() throws QueryEvaluationException {
					BindingSet next = super.next();
					consumedBindings++;
					return next;
				}

				@Override
				protected void handleClose() {
					try {
						flushTelemetry();
					} finally {
						super.handleClose();
					}
				}

				private void flushTelemetry() {
					if (flushed) {
						return;
					}
					flushed = true;
					recordProbeTelemetry(joinNode, sideNode, rightSide, consumedBindings);
				}
			};
		};
	}

	private static void recordProbeTelemetry(QueryModelNode joinNode, QueryModelNode sideNode, boolean rightSide,
			long consumedBindings) {
		if (rightSide) {
			if (consumedBindings <= 0) {
				incrementLongMetric(joinNode, TelemetryMetricNames.EMPTY_RIGHT_PROBE_COUNT_ACTUAL);
			} else {
				incrementLongMetric(joinNode, TelemetryMetricNames.LEFT_ROWS_WITH_MATCH_ACTUAL);
				setLongMetricMax(joinNode, TelemetryMetricNames.MAX_RIGHT_ROWS_PER_LEFT_ACTUAL, consumedBindings);
			}
		}
		if (consumedBindings <= 0) {
			return;
		}
		if (rightSide) {
			joinNode.setJoinRightBindingsConsumedActual(
					joinNode.getJoinRightBindingsConsumedActual() + consumedBindings);
			if (sideNode != null) {
				sideNode.setJoinRightBindingsConsumedActual(
						sideNode.getJoinRightBindingsConsumedActual() + consumedBindings);
			}
		} else {
			joinNode.setJoinLeftBindingsConsumedActual(joinNode.getJoinLeftBindingsConsumedActual() + consumedBindings);
			if (sideNode != null) {
				sideNode.setJoinLeftBindingsConsumedActual(
						sideNode.getJoinLeftBindingsConsumedActual() + consumedBindings);
			}
		}
	}

	private static void initializeJoinMetrics(QueryModelNode joinNode) {
		if (joinNode == null) {
			return;
		}

		joinNode.setJoinRightIteratorsCreatedActual(Math.max(0, joinNode.getJoinRightIteratorsCreatedActual()));
		joinNode.setJoinLeftBindingsConsumedActual(Math.max(0, joinNode.getJoinLeftBindingsConsumedActual()));
		joinNode.setJoinRightBindingsConsumedActual(Math.max(0, joinNode.getJoinRightBindingsConsumedActual()));
	}

	private static boolean runtimeTelemetryEnabled(QueryModelNode node) {
		return node != null && node.isRuntimeTelemetryEnabled();
	}

	private static long longMetric(QueryModelNode queryModelNode, String metricName) {
		return Math.max(0L, queryModelNode.getLongMetricActual(metricName));
	}

	private static void incrementLongMetric(QueryModelNode queryModelNode, String metricName) {
		addLongMetric(queryModelNode, metricName, 1L);
	}

	private static void addLongMetric(QueryModelNode queryModelNode, String metricName, long delta) {
		if (queryModelNode == null || delta <= 0) {
			return;
		}
		queryModelNode.setLongMetricActual(metricName, longMetric(queryModelNode, metricName) + delta);
	}

	private static void setLongMetricMax(QueryModelNode queryModelNode, String metricName, long value) {
		if (queryModelNode == null || value < 0) {
			return;
		}
		queryModelNode.setLongMetricActual(metricName, Math.max(longMetric(queryModelNode, metricName), value));
	}
}
