/*******************************************************************************
 * Copyright (c) 2026 Eclipse RDF4J contributors.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Distribution License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/org/documents/edl-v10.php.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 *******************************************************************************/
// Some portions generated by Codex
package org.eclipse.rdf4j.query.explanation;

import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertTrue;

import org.junit.jupiter.api.Test;

class GenericPlanNodeTest {

	@Test
	void toStringIncludesPopulatedTelemetryFields() {
		GenericPlanNode node = new GenericPlanNode("Join");
		node.setCostEstimate(1.0);
		node.setHasNextCallCountActual(2L);
		node.setHasNextTrueCountActual(3L);
		node.setHasNextTimeNanosActual(4L);
		node.setNextCallCountActual(5L);
		node.setNextTimeNanosActual(6L);
		node.setJoinRightIteratorsCreatedActual(7L);
		node.setJoinLeftBindingsConsumedActual(8L);
		node.setJoinRightBindingsConsumedActual(9L);
		node.setSourceRowsScannedActual(10L);
		node.setSourceRowsMatchedActual(11L);
		node.setSourceRowsFilteredActual(12L);

		String actual = node.toString();

		assertTrue(actual.contains("hasNextCallCountActual=2"), actual);
		assertTrue(actual.contains("hasNextTrueCountActual=3"), actual);
		assertTrue(actual.contains("hasNextTimeNanosActual=4"), actual);
		assertTrue(actual.contains("nextCallCountActual=5"), actual);
		assertTrue(actual.contains("nextTimeNanosActual=6"), actual);
		assertTrue(actual.contains("joinRightIteratorsCreatedActual=7"), actual);
		assertTrue(actual.contains("joinLeftBindingsConsumedActual=8"), actual);
		assertTrue(actual.contains("joinRightBindingsConsumedActual=9"), actual);
		assertTrue(actual.contains("sourceRowsScannedActual=10"), actual);
		assertTrue(actual.contains("sourceRowsMatchedActual=11"), actual);
		assertTrue(actual.contains("sourceRowsFilteredActual=12"), actual);
	}

	@Test
	void toStringOmitsZeroTelemetryFields() {
		GenericPlanNode node = new GenericPlanNode("Join");
		node.setCostEstimate(1.0);
		node.setHasNextCallCountActual(0L);
		node.setHasNextTrueCountActual(0L);
		node.setHasNextTimeNanosActual(0L);
		node.setNextCallCountActual(0L);
		node.setNextTimeNanosActual(0L);
		node.setJoinRightIteratorsCreatedActual(0L);
		node.setJoinLeftBindingsConsumedActual(0L);
		node.setJoinRightBindingsConsumedActual(0L);
		node.setSourceRowsScannedActual(0L);
		node.setSourceRowsMatchedActual(0L);
		node.setSourceRowsFilteredActual(0L);

		String actual = node.toString();

		assertFalse(actual.contains("hasNextCallCountActual="), actual);
		assertFalse(actual.contains("hasNextTrueCountActual="), actual);
		assertFalse(actual.contains("hasNextTimeNanosActual="), actual);
		assertFalse(actual.contains("nextCallCountActual="), actual);
		assertFalse(actual.contains("nextTimeNanosActual="), actual);
		assertFalse(actual.contains("joinRightIteratorsCreatedActual="), actual);
		assertFalse(actual.contains("joinLeftBindingsConsumedActual="), actual);
		assertFalse(actual.contains("joinRightBindingsConsumedActual="), actual);
		assertFalse(actual.contains("sourceRowsScannedActual="), actual);
		assertFalse(actual.contains("sourceRowsMatchedActual="), actual);
		assertFalse(actual.contains("sourceRowsFilteredActual="), actual);
	}

	@Test
	void toStringOmitsJoinTelemetryForNonJoinNodes() {
		GenericPlanNode node = new GenericPlanNode("Union");
		node.setCostEstimate(1.0);
		node.setJoinRightIteratorsCreatedActual(7L);
		node.setJoinLeftBindingsConsumedActual(8L);
		node.setJoinRightBindingsConsumedActual(9L);

		String actual = node.toString();

		assertFalse(actual.contains("joinRightIteratorsCreatedActual="), actual);
		assertFalse(actual.contains("joinLeftBindingsConsumedActual="), actual);
		assertFalse(actual.contains("joinRightBindingsConsumedActual="), actual);
	}

	@Test
	void toStringIncludesFilterDropCountEvenWhenZero() {
		GenericPlanNode node = new GenericPlanNode("Filter");
		node.setCostEstimate(1.0);
		node.setSourceRowsScannedActual(10L);
		node.setSourceRowsMatchedActual(10L);
		node.setSourceRowsFilteredActual(0L);

		String actual = node.toString();

		assertTrue(actual.contains("sourceRowsScannedActual=10"), actual);
		assertTrue(actual.contains("sourceRowsMatchedActual=10"), actual);
		assertTrue(actual.contains("sourceRowsFilteredActual=0"), actual);
	}

	@Test
	void toStringDerivesFilterRowMetricsFromChildAndResultSize() {
		GenericPlanNode node = new GenericPlanNode("Filter");
		node.setCostEstimate(1.0);
		node.setResultSizeActual(8L);

		GenericPlanNode child = new GenericPlanNode("StatementPattern");
		child.setResultSizeActual(12L);
		node.addPlans(child);

		String actual = node.toString();

		assertTrue(actual.contains("sourceRowsScannedActual=12"), actual);
		assertTrue(actual.contains("sourceRowsMatchedActual=8"), actual);
		assertTrue(actual.contains("sourceRowsFilteredActual=4"), actual);
	}

	@Test
	void toStringDerivesEstimateStabilityStatsFromChildPlans() {
		GenericPlanNode node = new GenericPlanNode("Join");
		node.setCostEstimate(1.0);

		GenericPlanNode childOne = new GenericPlanNode("StatementPattern");
		childOne.setResultSizeEstimate(10.0);
		childOne.setResultSizeActual(20L);

		GenericPlanNode childTwo = new GenericPlanNode("StatementPattern");
		childTwo.setResultSizeEstimate(8.0);
		childTwo.setResultSizeActual(8L);

		node.addPlans(childOne, childTwo);

		String actual = node.toString();

		assertTrue(actual.contains("sampleCountActual=2"), actual);
		assertTrue(actual.contains("varianceActual="), actual);
		assertTrue(actual.contains("stddevActual="), actual);
		assertTrue(actual.contains("confidenceScoreActual="), actual);
	}
}
